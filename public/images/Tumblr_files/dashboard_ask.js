(function(d,a){var c=c||function(g){return g};var e={initialize:function(){d(document).on("click","a.ask",_.bind(function(g){g.preventDefault();this.open_ask(d(g.currentTarget))},this))},open_ask:function(g){Tumblr.Popover.hide_all();var h=g.attr("data-tumblelog-name");var i=(parseInt(g.data("anonymous-ask"),10)===1)?true:false;this.model=new f();if(this.view){this.view.destroy()}this.view=new b({model:this.model,recipient:h,allow_anonymous:i}).show_form()}};var f=Backbone.Model.extend({defaults:{form_key:d("#tumblr_form_key").attr("content")},urlRoot:"/svc/post/ask",validate:function(g){if(!d.trim(g.question)){return{error:c("You need to enter a question!")}}else{if(this.is_url(g.question)){return{error:c("Sorry, but please don't include links in questions.")}}}if(g.response&&g.response.errors){return g.response.errors}},is_url:function(g){return !!(g.match(/(http|https):\/\//i)||g.match(/www\./i)||g.match(/[a-zA-Z0-9]+(\.arpa|\.root|\.aero|\.biz|\.cat|\.com|\.coop|\.edu|\.gov|\.info|\.int|\.jobs|\.mil|\.mobi|\.museum|\.name|\.net|\.org|\.pro|\.travel|TLD|\.ac|\.ad|\.ae|\.af|\.ag|\.ai|\.al|\.am|\.an|\.ao|\.aq|\.ar|\.as|\.at|\.au|\.aw|\.ax|\.az|\.ba|\.bb|\.bd|\.be|\.bf|\.bg|\.bh|\.bi|\.bj|\.bm|\.bn|\.bo|\.br|\.bs|\.bt|\.bv|\.bw|\.by|\.bz|\.ca|\.cc|\.cd|\.cf|\.cg|\.ch|\.ci|\.ck|\.cl|\.cm|\.cn|\.co|\.cr|\.cu|\.cv|\.cx|\.cy|\.cz|\.de|\.dj|\.dk|\.dm|\.do|\.dz|\.ec|\.ee|\.eg|\.er|\.es|\.et|\.eu|\.fi|\.fj|\.fk|\.fm|\.fo|\.fr|\.ga|\.gb|\.gd|\.ge|\.gf|\.gg|\.gh|\.gi|\.gl|\.gm|\.gn|\.gp|\.gq|\.gr|\.gs|\.gt|\.gu|\.gw|\.gy|\.hk|\.hm|\.hn|\.hr|\.ht|\.hu|\.id|\.ie|\.il|\.im|\.in|\.io|\.iq|\.ir|\.is|\.it|\.je|\.jm|\.jo|\.jp|\.ke|\.kg|\.kh|\.ki|\.km|\.kn|\.kr|\.kw|\.ky|\.kz|\.la|\.lb|\.lc|\.li|\.lk|\.lr|\.ls|\.lt|\.lu|\.lv|\.ly|\.ma|\.mc|\.md|\.mg|\.mh|\.mk|\.ml|\.mm|\.mn|\.mo|\.mp|\.mq|\.mr|\.ms|\.mt|\.mu|\.mv|\.mw|\.mx|\.my|\.mz|\.na|\.nc|\.ne|\.nf|\.ng|\.ni|\.nl|\.no|\.np|\.nr|\.nu|\.nz|\.om|\.pa|\.pe|\.pf|\.pg|\.ph|\.pk|\.pl|\.pm|\.pn|\.pr|\.ps|\.pt|\.pw|\.py|\.qa|\.re|\.ro|\.ru|\.rw|\.sa|\.sb|\.sc|\.sd|\.se|\.sg|\.sh|\.si|\.sj|\.sk|\.sl|\.sm|\.sn|\.so|\.sr|\.st|\.su|\.sv|\.sy|\.sz|\.tc|\.td|\.tf|\.tg|\.th|\.tj|\.tk|\.tl|\.tm|\.tn|\.to|\.tp|\.tr|\.tt|\.tv|\.tw|\.tz|\.ua|\.ug|\.uk|\.um|\.us|\.uy|\.uz|\.va|\.vc|\.ve|\.vg|\.vi|\.vn|\.vu|\.wf|\.ws|\.ye|\.yt|\.yu|\.za|\.zm|\.zw)/i))}});var b=Backbone.View.extend({className:"ask_container",events:{"click button.close":"__close_button_click","keydown #question":"__textarea_keydown","input #question":"__textarea_input","change #question":"__textarea_input","submit #ask_form":"__form_submit","change #ask_anonymously":"__ask_anonymously_change"},__close_button_click:function(g){g.preventDefault();this.hide_form()},__textarea_keydown:function(g){if(g.keyCode===13){g.preventDefault()}},__textarea_input:function(g){this.update()},__form_submit:function(g){g.preventDefault();this.submit_form()},__ask_anonymously_change:function(h){var g=d(h.currentTarget);this.toggle_anonymous(g)},__keydown:function(g){if(g.keyCode===27){this.hide_form(g)}},initialize:function(g){this.options=g||{};this.template=d("#dashboard_ask_template").html();this.$body=d("body");this.ask_limit=Tumblr.ASK_CHARACTER_LIMIT||500;this.recipient=this.options.recipient;this.recipient_avatar=this.options.recipient_avatar;this.allow_anonymous=this.options.allow_anonymous;this.render();var h={lines:13,length:6,width:2,radius:6,color:"rgba(0,0,0,.5)",speed:0.9,trail:34,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"0",left:"0"};this.keyboard_events={keydown:_.bind(this.__keydown,this)};this.spinner=new Spinner(h)},render:function(){var g=_.template(this.template);this.$body.append(this.$el.append(g({recipient:this.recipient,allow_anonymous:this.allow_anonymous})));this.cache_selectors();this.is_ie9=d("html").hasClass("ie9");if(this.is_ie9){this.disable_submit()}Tumblr.PlaceHolders.init({els:this.$("#question"),clear_on_submit:true});return this},cache_selectors:function(){this.$form=this.$("form");this.$loader=this.$(".post_loader");this.$plexi=this.$(".plexi");this.$question=this.$("#question");this.$character_count=this.$("#character_count");this.$post_form_wrapper=this.$(".post_form_wrapper");this.$close_button=this.$("button.close");this.$post_avatar=this.$(".post_avatar");this.$post_avatar_link=this.$(".post_avatar_link");this.$tumblelog_name=this.$("#from .tumblelog_name");this.$anonymous=this.$("#from .anonymous");this.$anonymous_avatar=this.$(".post_avatar .anonymous");this.$ask_button=this.$("#ask_button")},toggle_anonymous:function(g){this.is_anonymous=g.prop("checked");if(this.is_anonymous){this.$post_avatar_link.removeClass("use_blog_avatar");this.$tumblelog_name.hide();this.$anonymous.show()}else{this.$post_avatar_link.addClass("use_blog_avatar");this.$tumblelog_name.show();this.$anonymous.hide()}},show_form:function(){Tumblr.KeyCommands.suspend();d(document).on("keydown",this.keyboard_events.keydown);this.$body.addClass("scrollverlay_active");this.$plexi.addClass("active");setTimeout(_.bind(function(){this.$plexi.addClass("show");this.$post_form_wrapper.addClass("active")},this),10);return this},hide_form:function(){Tumblr.KeyCommands.resume();this.$post_form_wrapper.removeClass("active");this.$plexi.removeClass("show");setTimeout(_.bind(function(){this.$plexi.removeClass("active");this.destroy()},this),250);this.$body.removeClass("scrollverlay_active");return this},show_loader:function(){this.$loader.show();this.$close_button.hide();setTimeout(_.bind(function(){this.$loader.addClass("active")},this),10);this.spinner.spin(this.$(".loader").get(0))},hide_loader:function(){this.$close_button.show();this.$loader.removeClass("active");this.spinner.stop();this.$loader.hide()},serialize:function(i,j){var h={};var g=i.serializeArray();d.each(g,function(){if(h[this.name]!==undefined){if(!h[this.name].push){h[this.name]=[h[this.name]]}h[this.name].push(this.value||"")}else{h[this.name]=this.value||""}});return(j)?JSON.stringify(h):h},destroy:function(){this.remove();d(document).off("keydown",this.keyboard_events.keydown)},update:function(){if(d.trim(this.$question.val()).length>0){this.enable_submit()}else{this.disable_submit()}if(this.$question.val().match(/\n/g)){this.$question.val(this.$question.val().replace(/\n/g,""))}if(this.$question.val().length>this.ask_limit){this.$question.val(this.$question.val().substring(0,this.ask_limit))}var g=this.ask_limit-this.$question.val().length;this.$character_count.text(g);if(g<=100){this.$character_count.addClass("active");if(g>40){this.$character_count.css({color:"#a8b1ba"})}else{if(g>20&&g<=40){this.$character_count.css({color:"#b2212e"})}else{this.$character_count.css({color:"#cd1828"})}}}else{this.$character_count.removeClass("active")}},enable_submit:function(){if(!this.is_ie9){this.$ask_button.prop("disabled",false)}else{this.$ask_button.prop("disabled",false).removeClass("ui_disabled")}},disable_submit:function(){if(!this.is_ie9){this.$ask_button.prop("disabled",true)}else{this.$ask_button.prop("disabled",false).addClass("ui_disabled")}},submit_form:function(){var g=this.serialize(this.$form);this.show_loader();this.delay_loader=setTimeout(_.bind(function(){this.show_loader()},this),150);this.model.save(g,{success:_.bind(function(h){setTimeout(_.bind(function(){clearTimeout(this.delay_loader);if(typeof Tumblr.Toaster==="object"&&typeof Tumblr.ToastKit==="object"){var j="Sent to %1$s";j=Tumblr.ToastKit.__(j).replace("%1$s",this.recipient);var i={type:"image_text",message:"<strong>"+j+" </strong>",is_link:false,href:"#",img1:{url:(this.is_anonymous)?this.$anonymous_avatar.data("anonymous-avatar-url"):this.$post_avatar_link.data("user-avatar-url"),is_link:false,href:"#"}};Tumblr.Toaster.add_toast(i)}this.hide_form()},this),350)},this),error:_.bind(function(h,i){clearTimeout(this.delay_loader);this.hide_loader();this.display_errors(i)},this)})},show_messages:function(h,i){var j=this.$("."+h);var g=j.get(0);if(!g){return}j.empty();if(typeof i==="string"){i=[i]}_.each(i,function(l){var k=d("<li/>",{text:l});j.append(k)});j.show().fadeTo(250,1)},hide_messages:function(g){var h=this.$("."+g);if(!h.length){return}h.empty().hide()},display_errors:function(g){this.show_messages("errors",g)},hide_errors:function(){this.hide_messages("errors")}});a.DashboardAsk=e;a.DashboardAskModel=f;a.DashboardAskView=b})(jQuery,Tumblr||{});jQuery(function(){Tumblr.DashboardAsk.initialize()});